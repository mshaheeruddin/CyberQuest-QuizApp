import 'dart:math';

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:circular_countdown_timer/circular_countdown_timer.dart';
import 'package:audioplayers/audioplayers.dart';

import '../../game_main.dart';

class PenTesterMission1 extends StatefulWidget {
  const PenTesterMission1({Key? key}) : super(key: key);

  @override
  State<PenTesterMission1> createState() => _PenTesterMission1State();
}

class _PenTesterMission1State extends State<PenTesterMission1> {
  final player = AudioPlayer();

  void playBackgroundMusic() async {
    await player.play(UrlSource('https://audio.jukehost.co.uk/79WHZvEEBVtB8EgiDeegrGm9fUavd8BU'));
  }

  @override
  void initState() {
    super.initState();
    playBackgroundMusic();
  }

  final int _duration = 20;
  final CountDownController _controller = CountDownController();

  bool _isCountdownStarted = false;
  bool _isQuizFinished = false;
  int _currentQuestionIndex = 0;
  int _score = 0;
  String _resultLabel = '';
  bool _quizCompleted = false; // Flag to track if the quiz was completed before timer stops

  List<Map<String, dynamic>> _questions = [
    {
      'question': 'What is penetration testing?',
      'options': [
        'A method used to identify vulnerabilities in a system by simulating real-world attacks',
        'A technique used to encrypt sensitive data during transmission',
        'A process of validating the effectiveness of a firewall'
      ],
      'answer': 'A method used to identify vulnerabilities in a system by simulating real-world attacks'
    },
    {
      'question': 'What is the goal of reconnaissance in penetration testing?',
      'options': [
        'To gather information about the target system or network',
        'To exploit vulnerabilities and gain unauthorized access',
        'To launch a denial-of-service (DoS) attack'
      ],
      'answer': 'To gather information about the target system or network'
    },
    {
      'question': 'What is the difference between white-box and black-box testing?',
      'options': [
        'White-box testing involves having full knowledge of the system, while black-box testing involves no prior knowledge',
        'White-box testing is performed by internal testers, while black-box testing is performed by external testers',
        'White-box testing focuses on network security, while black-box testing focuses on application security'
      ],
      'answer': 'White-box testing involves having full knowledge of the system, while black-box testing involves no prior knowledge'
    },
    {
      'question': 'What is the main purpose of a vulnerability assessment?',
      'options': [
        'To identify and quantify vulnerabilities in a system or network',
        'To exploit vulnerabilities and gain unauthorized access',
        'To perform load testing and stress testing on a system'
      ],
      'answer': 'To identify and quantify vulnerabilities in a system or network'
    },
    {
      'question': 'What is the concept of social engineering in penetration testing?',
      'options': [
        'Using psychological manipulation to trick individuals into revealing confidential information',
        'Exploiting software vulnerabilities to gain unauthorized access',
        'Performing brute force attacks to guess passwords'
      ],
      'answer': 'Using psychological manipulation to trick individuals into revealing confidential information'
    },
    {
      'question': 'What is the purpose of vulnerability exploitation in penetration testing?',
      'options': [
        'To demonstrate the impact of a vulnerability by exploiting it',
        'To scan a network and identify open ports',
        'To perform data exfiltration from a target system'
      ],
      'answer': 'To demonstrate the impact of a vulnerability by exploiting it'
    },
    {
      'question': 'What is the goal of privilege escalation in penetration testing?',
      'options': [
        'To obtain higher levels of access or permissions in a system',
        'To intercept and alter communication between two parties',
        'To perform denial-of-service (DoS) attacks'
      ],
      'answer': 'To obtain higher levels of access or permissions in a system'
    },
    {
      'question': 'What is the purpose of a password cracking tool in penetration testing?',
      'options': [
        'To attempt to guess or crack passwords to gain unauthorized access',
        'To perform network sniffing and packet analysis',
        'To scan a network and identify vulnerabilities'
      ],
      'answer': 'To attempt to guess or crack passwords to gain unauthorized access'
    },
    {
      'question': 'What is the concept of a SQL injection in penetration testing?',
      'options': [
        'Exploiting vulnerabilities in a web application\'s database to manipulate or extract data',
        'Exploiting network protocols to intercept and alter communication',
        'Using social engineering techniques to trick users into revealing passwords'
      ],
      'answer': 'Exploiting vulnerabilities in a web application\'s database to manipulate or extract data'
    },
    {
      'question': 'What is the purpose of a firewall in penetration testing?',
      'options': [
        'To monitor and control incoming and outgoing network traffic',
        'To encrypt data during transmission',
        'To detect and remove malware from a system'
      ],
      'answer': 'To monitor and control incoming and outgoing network traffic'
    },
    {
      'question': 'What is the goal of a denial-of-service (DoS) attack in penetration testing?',
      'options': [
        'To disrupt or disable the availability of a system or network',
        'To intercept and alter communication between two parties',
        'To gain unauthorized access to a system'
      ],
      'answer': 'To disrupt or disable the availability of a system or network'
    },
    {
      'question': 'What is the concept of network scanning in penetration testing?',
      'options': [
        'Using automated tools to discover and map network resources',
        'Exploiting software vulnerabilities to gain unauthorized access',
        'Performing load testing to assess system performance'
      ],
      'answer': 'Using automated tools to discover and map network resources'
    },
    {
      'question': 'What is the purpose of a web application vulnerability scanner in penetration testing?',
      'options': [
        'To identify and assess vulnerabilities specific to web applications',
        'To perform network reconnaissance and gather information',
        'To encrypt sensitive data during transmission'
      ],
      'answer': 'To identify and assess vulnerabilities specific to web applications'
    },
    {
      'question': 'What is the goal of post-exploitation in penetration testing?',
      'options': [
        'To maintain access and gather additional information after exploiting a system',
        'To perform a vulnerability assessment of a network',
        'To perform data exfiltration from a target system'
      ],
      'answer': 'To maintain access and gather additional information after exploiting a system'
    },
    {
      'question': 'What is the concept of session hijacking in penetration testing?',
      'options': [
        'Taking control of a user session to gain unauthorized access',
        'Exploiting vulnerabilities in network protocols',
        'Using social engineering techniques to trick users into revealing passwords'
      ],
      'answer': 'Taking control of a user session to gain unauthorized access'
    },
    {
      'question': 'What is the purpose of a vulnerability management tool in penetration testing?',
      'options': [
        'To automate the process of identifying, tracking, and resolving vulnerabilities',
        'To perform network scanning and mapping',
        'To monitor and control incoming and outgoing network traffic'
      ],
      'answer': 'To automate the process of identifying, tracking, and resolving vulnerabilities'
    },
    {
      'question': 'What is the goal of a wireless security assessment in penetration testing?',
      'options': [
        'To identify and assess vulnerabilities in wireless networks',
        'To perform network sniffing and packet analysis',
        'To exploit software vulnerabilities and gain unauthorized access'
      ],
      'answer': 'To identify and assess vulnerabilities in wireless networks'
    },
    {
      'question': 'What is the concept of a reverse shell in penetration testing?',
      'options': [
        'A technique used to establish a remote connection from a target system to an attacker-controlled system',
        'Exploiting software vulnerabilities to gain unauthorized access',
        'Using social engineering techniques to trick users into revealing passwords'
      ],
      'answer': 'A technique used to establish a remote connection from a target system to an attacker-controlled system'
    },
    {
      'question': 'What is the purpose of a network sniffer in penetration testing?',
      'options': [
        'To capture and analyze network traffic for security assessment',
        'To encrypt data during transmission',
        'To scan a network and identify open ports'
      ],
      'answer': 'To capture and analyze network traffic for security assessment'
    },
    {
      'question': 'What is the goal of privilege escalation in penetration testing?',
      'options': [
        'To obtain higher levels of access or permissions in a system',
        'To intercept and alter communication between two parties',
        'To perform denial-of-service (DoS) attacks'
      ],
      'answer': 'To obtain higher levels of access or permissions in a system'
    },
    {
      'question': 'What is the purpose of a password cracking tool in penetration testing?',
      'options': [
        'To attempt to guess or crack passwords to gain unauthorized access',
        'To perform network sniffing and packet analysis',
        'To scan a network and identify vulnerabilities'
      ],
      'answer': 'To attempt to guess or crack passwords to gain unauthorized access'
    },
    {
      'question': 'What is the concept of a SQL injection in penetration testing?',
      'options': [
        'Exploiting vulnerabilities in a web application\'s database to manipulate or extract data',
        'Exploiting network protocols to intercept and alter communication',
        'Using social engineering techniques to trick users into revealing passwords'
      ],
      'answer': 'Exploiting vulnerabilities in a web application\'s database to manipulate or extract data'
    },
    {
      'question': 'What is the purpose of a firewall in penetration testing?',
      'options': [
        'To monitor and control incoming and outgoing network traffic',
        'To encrypt data during transmission',
        'To detect and remove malware from a system'
      ],
      'answer': 'To monitor and control incoming and outgoing network traffic'
    },
    {
      'question': 'What is the goal of a denial-of-service (DoS) attack in penetration testing?',
      'options': [
        'To disrupt or disable the availability of a system or network',
        'To intercept and alter communication between two parties',
        'To gain unauthorized access to a system'
      ],
      'answer': 'To disrupt or disable the availability of a system or network'
    },
    {
      'question': 'What is the concept of network scanning in penetration testing?',
      'options': [
        'Using automated tools to discover and map network resources',
        'Exploiting software vulnerabilities to gain unauthorized access',
        'Performing load testing to assess system performance'
      ],
      'answer': 'Using automated tools to discover and map network resources'
    },
    {
      'question': 'What is the purpose of a web application vulnerability scanner in penetration testing?',
      'options': [
        'To identify and assess vulnerabilities specific to web applications',
        'To perform network reconnaissance and gather information',
        'To encrypt sensitive data during transmission'
      ],
      'answer': 'To identify and assess vulnerabilities specific to web applications'
    },
    {
      'question': 'What is the goal of post-exploitation in penetration testing?',
      'options': [
        'To maintain access and gather additional information after exploiting a system',
        'To perform a vulnerability assessment of a network',
        'To perform data exfiltration from a target system'
      ],
      'answer': 'To maintain access and gather additional information after exploiting a system'
    },
    {
      'question': 'What is the concept of session hijacking in penetration testing?',
      'options': [
        'Taking control of a user session to gain unauthorized access',
        'Exploiting vulnerabilities in network protocols',
        'Using social engineering techniques to trick users into revealing passwords'
      ],
      'answer': 'Taking control of a user session to gain unauthorized access'
    },
    {
      'question': 'What is the purpose of a vulnerability management tool in penetration testing?',
      'options': [
        'To automate the process of identifying, tracking, and resolving vulnerabilities',
        'To perform network scanning and mapping',
        'To monitor and control incoming and outgoing network traffic'
      ],
      'answer': 'To automate the process of identifying, tracking, and resolving vulnerabilities'
    },
    {
      'question': 'What is the goal of a wireless security assessment in penetration testing?',
      'options': [
        'To identify and assess vulnerabilities in wireless networks',
        'To perform network sniffing and packet analysis',
        'To exploit software vulnerabilities and gain unauthorized access'
      ],
      'answer': 'To identify and assess vulnerabilities in wireless networks'
    },
    {
      'question': 'What is the concept of a reverse shell in penetration testing?',
      'options': [
        'A technique used to establish a remote connection from a target system to an attacker-controlled system',
        'Exploiting software vulnerabilities to gain unauthorized access',
        'Using social engineering techniques to trick users into revealing passwords'
      ],
      'answer': 'A technique used to establish a remote connection from a target system to an attacker-controlled system'
    },
    {
      'question': 'What is the purpose of a network sniffer in penetration testing?',
      'options': [
        'To capture and analyze network traffic for security assessment',
        'To encrypt data during transmission',
        'To scan a network and identify open ports'
      ],
      'answer': 'To capture and analyze network traffic for security assessment'
    }
  ];




  void _selectAnswer(String selectedAnswer) {
    if (!_isCountdownStarted) {
      return;
    }

    final currentQuestion = _questions[_currentQuestionIndex];
    final correctAnswer = currentQuestion['answer'];

    if (selectedAnswer == correctAnswer) {
      setState(() {
        _score += 5;
        _resultLabel = 'CORRECT!';
      });
    } else {
      setState(() {
        _resultLabel = 'NOT CORRECT';
      });
    }

    if (_currentQuestionIndex < _questions.length - 1) {
      setState(() {
        _currentQuestionIndex++;
        _resultLabel = '';
      });
    } else {
      setState(() {
        _isQuizFinished = true;
        _quizCompleted = true; // Set the flag when the quiz is completed
        _showFinalScoreDialog(); // Show the final score dialog
      });
    }
  }

  void _showFinalScoreDialog() {
    String message;

    if (_score >= 15) {
      message = "Great job, Pen Tester! You did an excellent job!";
    } else if (_score >= 10) {
      message = "Well done, Pen Tester! You did a good job!";
    } else {
      message = "Good effort, Pen Tester! Keep practicing!";
    }

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Quiz Completed'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(message),
            SizedBox(height: 20),
            Text('Final Score: $_score'),
          ],
        ),
        actions: [
          ElevatedButton(
            onPressed: () {
              Navigator.of(context).pop();
              Navigator.push(context,
                  CupertinoPageRoute(builder: (context) => MainScreen()));
            },
            child: Text('OK'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        mainAxisAlignment: MainAxisAlignment.start,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Stack(
            children: [
              Padding(
                padding: EdgeInsets.only(top: 30),
                child: IconButton(
                  onPressed: () {},
                  icon: FaIcon(FontAwesomeIcons.arrowLeft),
                ),
              ),
            ],
          ),
          Padding(
            padding: const EdgeInsets.only(top: 20.0, left: 14),
            child: Text(
              "Welcome To Mission 1, Pen Tester!",
              style: GoogleFonts.adventPro(fontSize: 30),
            ),
          ),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                'Score: ',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              Text(
                '$_score',
                style: TextStyle(fontSize: 18),
              ),
            ],
          ),
          Expanded(
            child: SingleChildScrollView(
              child: Padding(
                padding: EdgeInsets.only(
                  left: MediaQuery.of(context).size.width * 0.3,
                  top: MediaQuery.of(context).size.height * 0.1,
                ),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SizedBox(
                      width: MediaQuery.of(context).size.width * 0.4,
                      height: MediaQuery.of(context).size.width * 0.4,
                      child: GestureDetector(
                        onTap: () {
                          if (!_isCountdownStarted) {
                            _controller.start();
                          }
                        },
                        child: CircularCountDownTimer(
                          duration: _duration,
                          initialDuration: 0,
                          controller: _controller,
                          ringColor: Colors.grey[300]!,
                          fillColor: Colors.purpleAccent[100]!,
                          backgroundColor: Colors.purple[500],
                          strokeWidth: 10.0,
                          strokeCap: StrokeCap.round,
                          textStyle: const TextStyle(
                            fontSize: 24.0,
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                          ),
                          textFormat: CountdownTextFormat.S,
                          isReverse: false,
                          isReverseAnimation: false,
                          isTimerTextShown: true,
                          autoStart: false,
                          onStart: () {
                            debugPrint('Countdown Started');
                            setState(() {
                              _isCountdownStarted = true;
                            });
                          },
                          onComplete: () {
                            debugPrint('Countdown Ended');
                            if (!_quizCompleted) {
                              _showFinalScoreDialog();
                            }
                          },
                          onChange: (String timeStamp) {
                            debugPrint('Countdown Changed $timeStamp');
                          },
                          timeFormatterFunction: (defaultFormatterFunction, duration) {
                            if (duration.inSeconds == 0) {
                              return "Start";
                            } else {
                              return Function.apply(defaultFormatterFunction, [duration]);
                            }
                          },
                          width: 100,
                          height: 100,
                        ),
                      ),
                    ),
                    const SizedBox(height: 20),
                    Text(
                      _resultLabel,
                      style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                    ),
                  ],
                ),
              ),
            ),
          ),
          Center(
            child: Card(
              elevation: 3,
              margin: EdgeInsets.symmetric(vertical: 20, horizontal: 20),
              child: Padding(
                padding: const EdgeInsets.all(20.0),
                child: Column(
                  children: [
                    Text(
                      _questions[_currentQuestionIndex]['question'],
                      style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                    ),
                    ButtonBar(
                      alignment: MainAxisAlignment.center,
                      children: [
                        for (String option in _shuffleOptions(_questions[_currentQuestionIndex]['options']))
                          SizedBox(
                            width: 400,
                            child: ElevatedButton(
                              onPressed: _isCountdownStarted ? () => _selectAnswer(option) : null,
                              child: Text(option),
                            ),
                          ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
  final _random = Random();
  List<String> _shuffleOptions(List<String> options) {
    // Create a copy of the original options list
    List<String> shuffledOptions = List<String>.from(options);

    // Shuffle the options using the Fisher-Yates algorithm
    for (int i = shuffledOptions.length - 1; i > 0; i--) {
      int j = _random.nextInt(i + 1);
      String temp = shuffledOptions[i];
      shuffledOptions[i] = shuffledOptions[j];
      shuffledOptions[j] = temp;
    }

    return shuffledOptions;
  }
}